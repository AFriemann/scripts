#!/usr/bin/env python

import argparse
from os import remove
from subprocess import Popen, PIPE
import webbrowser

class Md2Html(argparse.Action):
    def __call__(self, parser, namespace, values, option_string=None):
        setattr(namespace, self.dest, values)
        in_file = open(namespace.in_file[0], 'r')

        markdown = Popen('markdown', stdin=PIPE, stdout=PIPE)
        html, err = markdown.communicate(in_file.read())

        of_name = in_file.name.replace('.md','.html') if len(namespace.in_file) == 1 else namespace.in_file[1]

        out_file = open(of_name, 'w')
        out_file.write(html)

        in_file.close()
        out_file.close()

        if namespace.preview:
            webbrowser.open(of_name)
            remove(of_name)

parser = argparse.ArgumentParser(
    prog='md2html', 
    description='Create html files from markdown text files', 
    usage='%(prog)s [options]')

parser.add_argument(
    '-p', '--preview', 
    action='store_true',
    help='preview file in browser')

parser.add_argument(
    'in_file', 
    nargs='+',
    action=Md2Html,
    help='markdown file')

args = parser.parse_args()

